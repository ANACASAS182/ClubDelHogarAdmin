<ion-header class="modalHeader">
  <ion-toolbar>
    <ion-buttons slot="end">
      <ion-button class="btn-close" (click)="close()" aria-label="Cerrar">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" [fullscreen]="false">
  <h2 class="modalform-title ion-text-center">Seguimiento de referido</h2>

  <!-- ===== FICHA DEL REFERIDO ===== -->
  <ion-card class="section-card">
    <ion-card-header>
      <ion-card-title class="section-title">Referido</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="detail-grid">
        <div class="detail-row">
          <div class="detail-label">Nombre</div>
          <div class="detail-value">{{ referido?.nombreCompleto }}</div>
        </div>

        <div class="detail-row">
          <div class="detail-label">Email</div>
          <div class="detail-value">
            <ion-chip *ngIf="referido?.email; else sinCorreo" outline="true" color="medium" class="chip">
              <ion-icon name="mail-outline"></ion-icon>
              <ion-label>{{ referido?.email }}</ion-label>
            </ion-chip>
            <ng-template #sinCorreo><span class="muted">Sin correo</span></ng-template>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-label">Celular</div>
          <div class="detail-value">
            <ion-chip outline="true" color="medium" class="chip">
              <ion-icon name="call-outline"></ion-icon>
              <ion-label>{{ referido?.celular || 'No proporcionado' }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-label">Producto</div>
          <div class="detail-value">{{ referido?.productoNombre }}</div>
        </div>

        <div class="detail-row">
          <div class="detail-label">Embajador</div>
          <div class="detail-value">{{ referido?.usuarioNombreCompleto }}</div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

    <!-- ===== ESTATUS ===== -->
  <ion-card class="section-card">
    <ion-card-header>
      <ion-card-title class="section-title">Estatus</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <form [formGroup]="formStatus" class="status-form" (ngSubmit)="enviarFormularioStatus()">
        <ion-select
          class="inputForm"
          okText="Ok"
          cancelText="Cancelar"
          label-placement="floating"
          label="Estatus seguimiento"
          formControlName="status"
          (ionBlur)="statusCtrl.markAsTouched()">

          <ion-select-option
            *ngFor="let item of estatus"
            [value]="item.valor + ''"
            [disabled]="isCreadoDisabled(item.valor)">
            {{ item.nombre }}
          </ion-select-option>

        </ion-select>

        <div class="actions-row">
          <ion-button type="submit" [disabled]="formEnviado || formStatus.invalid">
            Actualizar estatus
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>  <!-- ðŸ‘ˆ ESTOS DOS CIERRES FALTABAN -->


  <!-- ===== NUEVO SEGUIMIENTO ===== -->
  <ion-card class="section-card" *ngIf="showSegForm">
  <ion-card-header>
    <ion-card-title class="section-title">Agregar seguimiento</ion-card-title>
  </ion-card-header>
  <ion-card-content>
    <!-- CONTENEDOR, NO FORM para evitar nesting -->
    <div [formGroup]="formulario">
      <ion-textarea
        formControlName="comentario"
        label-placement="floating"
        label="Seguimiento"
        class="inputForm"
        [class.invalid]="comentarioCtrl.invalid && comentarioCtrl.touched"
        autoGrow="true"
        rows="4"
        maxlength="500"
        placeholder="Escribe tu seguimiento">
      </ion-textarea>

      <ion-text color="danger" *ngIf="comentarioCtrl.invalid && comentarioCtrl.touched">
        Campo requerido
      </ion-text>

      <div class="actions-row">
        <ion-button (click)="enviarFormulario()" [disabled]="formEnviado || formulario.invalid">
          Enviar seguimiento
        </ion-button>
      </div>
    </div>
  </ion-card-content>
</ion-card>


  <!-- ===== HISTORIAL ===== -->
  <ion-card class="section-card">
    <ion-card-header>
      <ion-card-title class="section-title">
        Seguimientos <span class="count">({{ numSeguimientos }})</span>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="timeline" *ngIf="(seguimientos?.length ?? 0) > 0; else sinSeg">
        <div class="tl-item" *ngFor="let item of (mostrarTodos ? seguimientos : (seguimientos | slice:0:5)); trackBy: trackByIndex">
          <div class="tl-dot"></div>
          <div class="tl-card">
            <div class="tl-row">
              <ion-icon name="time-outline"></ion-icon>
              <span class="tl-date">{{ formatFecha(item.fechaSeguimiento!) }}</span>
            </div>
            <div class="tl-text">{{ item.comentario }}</div>
          </div>
        </div>
      </div>

      <ng-template #sinSeg>
        <span class="muted">AÃºn no hay seguimientos</span>
      </ng-template>

      <div class="actions-row" *ngIf="(seguimientos?.length ?? 0) > 5">
        <ion-button size="small" fill="clear" (click)="mostrarTodos = !mostrarTodos">
          {{ mostrarTodos ? 'Ver menos' : 'Ver todos' }}
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>