<ion-header class="modalHeader">
  <ion-toolbar>
    <ion-buttons slot="end">
      <ion-button class="btn-close" (click)="close()" aria-label="Cerrar">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" [fullscreen]="false">
  <h2 class="modalform-title ion-text-center">Seguimiento de referido</h2>

  <!-- ===== FICHA DEL REFERIDO ===== -->
  <ion-card class="section-card">
  <ion-card-header>
    <ion-card-title class="section-title">Estatus</ion-card-title>
  </ion-card-header>

  <ion-card-content>
    <form [formGroup]="formStatus" class="status-form">
      <ion-select
        [interfaceOptions]="{ header: 'Estatus de seguimiento'}"
        class="inputForm"
        okText="Ok"
        cancelText="Cancelar"
        label-placement="floating"
        label="Estatus seguimiento"
        formControlName="status"
        [compareWith]="compareNum"
        (ionBlur)="statusCtrl?.markAsTouched()">

        <ion-select-option
          *ngFor="let item of estatus"
          [value]="item.valor"
          [disabled]="isCreadoDisabled(item.valor)">
          {{ item.nombre }}
        </ion-select-option>
      </ion-select>

      <ion-text color="danger" *ngIf="statusCtrl?.invalid && statusCtrl?.touched">
        Campo requerido
      </ion-text>

      <div class="actions-row">
        <ion-button [disabled]="formEnviado" (click)="enviarFormularioStatus()">
          Actualizar estatus
        </ion-button>
      </div>
    </form>
  </ion-card-content>
</ion-card>

  <!-- ===== ESTATUS ===== -->
  <ion-card class="section-card">
    <ion-card-header>
      <ion-card-title class="section-title">Estatus</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <form [formGroup]="formStatus" class="status-form">
        <ion-select
          [interfaceOptions]="{ header: 'Estatus de seguimiento'}"
          class="inputForm"
          okText="Ok"
          cancelText="Cancelar"
          label-placement="floating"
          label="Estatus seguimiento"
          formControlName="status"
          [compareWith]="compareNum"
          (ionBlur)="statusCtrl?.markAsTouched()">

          <ion-select-option
            *ngFor="let item of estatus"
            [value]="item.valor"
            [disabled]="isCreadoDisabled(item.valor)">
            {{ item.nombre }}
          </ion-select-option>
        </ion-select>

        <ion-text color="danger" *ngIf="statusCtrl?.invalid && statusCtrl?.touched">
          Campo requerido
        </ion-text>

        <div class="actions-row">
          <ion-button [disabled]="formEnviado" (click)="enviarFormularioStatus()">
            Actualizar estatus
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- ===== NUEVO SEGUIMIENTO (solo cuando está en Seguimiento) ===== -->
  <ion-card class="section-card" *ngIf="referido?.estatusReferenciaEnum == estatusReferenciaEnum.Seguimiento">
    <ion-card-header>
      <ion-card-title class="section-title">Agregar seguimiento</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="formulario">
        <ion-textarea
          formControlName="comentario"
          label-placement="floating"
          label="Seguimiento"
          class="inputForm"
          [class.invalid]="getControl('comentario')?.invalid && getControl('comentario')?.touched"
          autoGrow="true"
          rows="4"
          maxlength="500"
          placeholder="Escribe tu seguimiento">
        </ion-textarea>

        <ion-text color="danger" *ngIf="getControl('comentario')?.invalid && getControl('comentario')?.touched">
          Campo requerido
        </ion-text>

        <div class="actions-row">
          <ion-button [disabled]="formEnviado" (click)="enviarFormulario()">
            Enviar seguimiento
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- ===== HISTORIAL DE SEGUIMIENTOS ===== -->
  <ion-card class="section-card">
    <ion-card-header>
      <ion-card-title class="section-title">
        Seguimientos <span class="count">({{ numSeguimientos }})</span>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="timeline" *ngIf="(seguimientos?.length ?? 0) > 0; else sinSeg">
        <div class="tl-item"
             *ngFor="let item of (mostrarTodos ? seguimientos : (seguimientos | slice:0:5)); trackBy: trackByIndex">
          <div class="tl-dot"></div>
          <div class="tl-card">
            <div class="tl-row">
              <ion-icon name="time-outline"></ion-icon>
              <span class="tl-date">{{ formatFecha(item.fechaSeguimiento!) }}</span>
            </div>
            <div class="tl-text">{{ item.comentario }}</div>
          </div>
        </div>
      </div>

      <ng-template #sinSeg>
        <span class="muted">Aún no hay seguimientos</span>
      </ng-template>

      <div class="actions-row" *ngIf="(seguimientos?.length ?? 0) > 5">
        <ion-button size="small" fill="clear" (click)="mostrarTodos = !mostrarTodos">
          {{ mostrarTodos ? 'Ver menos' : 'Ver todos' }}
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>